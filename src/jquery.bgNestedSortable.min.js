(function(f){f.fn.bgNestedSortable=function(z){var y={tolerance:1,interval:30,expandCollapse:true,dragAndDrop:true,edit:true,initHidden:true,dataName:"data",dataClass:"nested-data",dataCellClass:"nested-data-cell",iconClass:"nested-data-icon",parentClass:"has-children",addClass:"add-child",removeClass:"remove-child",blurCallback:false,addChildCallback:false,deleteCallback:false,dropCallback:false,appendCallback:false,insertBeforeCallback:false,insertAfterCallback:false,childHtml:'<td class="%dataCellClass%"><span class="add-edit-icons"><a href="#" title="Add child" class="%addClass%"><img src="/pix/bgNestedSortable/add.gif" alt="Add child" width="12" height="12" /></a><a href="#" title="Edit node"><img src="/pix/bgNestedSortable/edit.gif" alt="Edit node" width="12" height="12" /></a></span><span class="%iconClass%"></span><form action="#" method="post"><input type="hidden" name="id" id="row%ID%-id" value="0" /><input type="hidden" name="categoryID" id="row%ID%-categoryID" value="" /><span class="%dataClass%">Ny artikel</span></form></td><td></td><td></td>'};if(z){f.extend(y,z)}y.appendCallback=(false==y.appendCallback)?y.dropCallback:y.appendCallback;y.insertBeforeCallback=(false==y.insertBeforeCallback)?y.dropCallback:y.insertBeforeCallback;y.insertAfterCallback=(false==y.insertAfterCallback)?y.dropCallback:y.insertAfterCallback;this.each(function(){var O=this;f(O).data("config",y);var I=0;var C=0;var K={x:0,y:0};var D;var L=false;var A=false;var G;var F;var B;var J;var M;var E={appendTo:"body",revert:"invalid",revertDuration:0,drag:function(Q,P){C=new Date().getTime();if(y.interval>C-I){return}I=C;D={x:Q.pageX,y:Q.pageY};if(K.x==D.x&&K.y==D.y){return}K=D;F=f(O).find(".ui-droppable-hover");B=0;if(0<F.length){B=c(Q.pageX,Q.pageY,F);J=F.offset();M=F.height();G=(null==J)?false:x(Q.pageY,J.top,M);if(G){m(O);e(O,L,F);L=G;A=F}}else{if(A){B=c(Q.pageX,Q.pageY,A)}}if(parseInt(y.tolerance)<parseInt(B)){m(O);L=false;A=false}},stop:function(Q,P){if(p(P.helper,A)){switch(L){case"append":a(O,P.helper);u(O,f(Q.target));f(Q.target).remove();j(O,P.helper,A);break;case"insertBefore":u(O,f(Q.target));f(Q.target).remove();d(O,P.helper,A);break;case"insertAfter":u(O,f(Q.target));f(Q.target).remove();t(O,P.helper,A);break;default:break}}else{alert("You can't drop there")}m(O)},helper:function(R,Q){var P=f('<div class="nested-table-item-dragging"><table class="nested-sortable"></table></div>').find("table").append(f(R.target).closest("tr").clone());return v(O,P,f(R.target).closest("tr")).end()}};var N={tolerance:"pointer",activeClass:"ui-droppable-active",hoverClass:"ui-droppable-hover",drop:function(){}};f(O).find("tr").draggable(E).droppable(N).data("init",true);f(O).find("tr").live("mouseover",function(){if(!f(this).data("init")){f(this).data("init",true);f(this).draggable(E).droppable(N)}});var H;if(y.initHidden){f(O).find("tr[class*='child-of-']").hide();H="collapsed"}else{H="expanded"}f(O).find("tr[class*='"+y.parentClass+"']").addClass(H);f(O).find("tr."+y.parentClass+" td."+y.dataCellClass+" ."+y.iconClass).live("click",function(P){f(this).closest("td."+y.dataCellClass).toggleClass("collapsed").toggleClass("expanded");f(this).closest("tr").toggleClass("collapsed").toggleClass("expanded");o(O,f(this).closest("tr"));P.preventDefault()});if(true===y.edit){f(O).find("tr").live("mouseover",function(P){f(this).addClass("hover")});f(O).find("tr").live("mouseout",function(P){f(this).removeClass("hover")});f(O).find("tr td."+y.dataCellClass+" ."+y.dataClass).live("click",function(S){if(0>=f(this).find("input").length){f(this).closest("tr").addClass("active");var Q=f(this).closest("td."+y.dataClass).attr("id");var R=f(this).html();var P='<input type="text" id="'+Q+"-"+y.dataName+'" name="'+y.dataName+'" value="'+R+'" />';f(this).html(P);f(this).find("input").focus()}});f(O).find("tr td."+y.dataCellClass+" ."+y.dataClass+" input").live("blur",function(R){f(this).closest("tr").removeClass("active");if(f.isFunction(y.blurCallback)){var P=k(O,f(this).closest("tr"));y.blurCallback.call(this,f(this).closest("tr"),P)}var Q=f(this).val();f(this).closest("td."+y.dataCellClass+" ."+y.dataClass).html(Q)});f(O).find("td."+y.dataCellClass+" ."+y.addClass).live("click",function(Q){f(this).closest("tr").find("td."+y.dataCellClass+" ."+y.dataClass+" input").trigger("blur");var P=g(O,f(this).closest("tr"));f("tr#"+P).find("td."+y.dataCellClass+" ."+y.dataClass).trigger("click")});f(O).find("td."+y.dataCellClass+" ."+y.removeClass).live("click",function(Q){var P=f(this).closest("tr");if(f.isFunction(y.deleteCallback)){y.deleteCallback.call(this,P)}u(O,P);P.remove()})}});return this};function o(y,z){var B=z.attr("id");var A=f(y).find(".child-of-"+B+".expanded");f(y).find(".child-of-"+B).each(function(){f(this).toggle()});if(0<A.length){A.each(function(){o(y,f(this))})}}function h(y,A){var B=A.attr("id");var z=f(y).find(".child-of-"+B);f(y).find(".child-of-"+B).each(function(){f(this).show()})}function v(y,B,A){var z=f(y).data("config");f(y).find(".child-of-"+A.attr("id")).each(function(){B.append(f(this).clone());if(f(this).hasClass(z.parentClass)){v(y,B,f(this))}});return B}function p(y,z){if(0<f(y).find("#"+f(z).attr("id")).length){return false}return true}function j(y,C,E){var z=f(y).data("config");var B=E;var D=C.find("table tbody").children("tr:first").attr("id");i(y,C,E);var A=f('<div class="family-holder"><table></table></div>');v(y,A,E);if(A.find("tr").length>0){E=f(y).find("#"+A.find("tr:last-child").attr("id"))}C.find("table tbody").children().insertAfter(f(E));l(y);if(f.isFunction(z.appendCallback)){var F=f(y).find("tr#"+D);z.appendCallback.call(this,F,B)}}function d(y,B,D){var z=f(y).data("config");var C=B.find("table tbody").children("tr:first").attr("id");var A=k(y,D);i(y,B,A);B.find("table tbody").children().insertBefore(f(D));l(y);if(f.isFunction(z.insertBeforeCallback)){var E=f(y).find("tr#"+C);z.insertBeforeCallback.call(this,E,A)}}function t(y,C,E){var z=f(y).data("config");var D=C.find("table tbody").children("tr:first").attr("id");var B=k(y,E);var A=f('<div class="family-holder"><table></table></div>');v(y,A,E);if(A.find("tr").length>0){E=f(y).find("#"+A.find("tr:last-child").attr("id"))}i(y,C,B);C.find("table tbody").children().insertAfter(f(E));l(y);if(f.isFunction(z.insertAfterCallback)){var F=f(y).find("tr#"+D);z.insertAfterCallback.call(this,F,B)}}function i(y,B,C){var A=f(y).data("config");var D=(false==C)?-1:r(f(C).attr("class"));var z=r(B.find("table tbody").find("tr:first-child").attr("class"));B.find("table tbody tr.level"+z).each(function(){b(C,this)});B.find("table tbody").children().each(function(){q(D,z,this)})}function l(y){var z=f(y).data("config");f(y).find("tr").each(function(){var B=f(this).attr("id");if(0<B.length){var A=f(y).find("#"+B);if(0>=f(y).find(".child-of-"+B).length){A.removeClass(z.parentClass+" expanded collapsed");A.find("td."+z.dataCellClass).removeClass(z.parentClass+" expanded collapsed")}else{A.addClass(z.parentClass+" expanded");A.find("td."+z.dataCellClass).addClass(z.parentClass+" expanded")}}})}function u(y,A){var z=f(y).data("config");f(y).find(".child-of-"+A.attr("id")).each(function(){if(f(this).hasClass(z.parentClass)){u(y,f(this))}f(this).remove()})}function r(A){var z=A.indexOf("level")+5;var y=A.indexOf(" ",z);return(-1!=y)?parseInt(A.substring(z,y)):parseInt(A.substring(z))}function q(B,A,C){var z=r(f(C).attr("class"));var y=B+1+(z-A);f(C).removeClass("level"+z);f(C).addClass("level"+y)}function k(y,B){var z=s(B);var A=(false==z)?false:z.substring(9);return(false==z)?false:f(y).find("#"+A)}function b(y,A){var z=s(A);f(A).removeClass(z);if(false!=y){f(A).addClass("child-of-"+f(y).attr("id"))}}function s(B){var A=f(B).attr("class");if(undefined===A){return false}var z=A.indexOf("child-of-");var y=A.indexOf(" ",z);if(-1==z){return false}return(-1!=y)?A.substring(z,y):A.substring(z)}function a(y,E){var B=f(y).data("config");var C=f(E).attr("class");var A=C.indexOf("child-of-")+9;var z=C.indexOf(" ",A);var D=(-1!=z)?C.substring(A,z):C.substring(A);if(0>=f(y).find(".child-of-"+D).length){f(y).find("#"+D).removeClass(B.parentClass+" expanded collapsed")}else{f(y).find("#"+D).addClass(B.parentClass+" expanded collapsed")}}function g(y,B){var A=f(y).data("config");f(B).addClass(A.parentClass).addClass("expanded");f(B).find("td."+A.dataCellClass).addClass("expanded");h(y,B);var F=0;f(y).find("tr").each(function(G,H){curId=parseInt(f(this).attr("id").substring(3));F=(F<curId)?curId:F});F++;var E=r(f(B).attr("class"))+1;var D=f(B).attr("id");var z=A.childHtml.replace(/%dataCellClass%/ig,A.dataCellClass).replace(/%addClass%/ig,A.addClass).replace(/%removeClass%/ig,A.removeClass).replace(/%iconClass%/ig,A.iconClass).replace(/%dataClass%/ig,A.dataClass).replace(/%ID%/ig,F);var C=f('<tr id="row'+F+'" class="child-of-'+D+" level"+E+'">'+z+"</tr>").insertAfter(f(B));if(f.isFunction(A.addChildCallback)){A.addChildCallback.call(this,C,B)}return"row"+F}function x(C,D,y){var B={top:D,bottom:D+y};var A={top:D,bottom:D+(y*0.2)};var z={top:D+y-(y*0.2),bottom:D+y};var E=false;E=(C>B.top&&C<B.bottom)?"append":E;E=(C>A.top&&C<A.bottom)?"insertBefore":E;E=(C>z.top&&C<z.bottom)?"insertAfter":E;return E}function e(y,A,z){z.removeClass("bg-nested-table-droppable-append-hover");z.siblings().removeClass("bg-nested-table-droppable-hover");switch(A){case"append":z.addClass("bg-nested-table-droppable-append-hover");break;case"insertBefore":n(y,A,z);break;case"insertAfter":n(y,A,z);break;default:break}}function n(y,F,D){var A=f(y).data("config");var z=parseInt(D.parent("tbody").find("tr:first-child td."+A.dataCellClass).width());var H=parseInt(z-D.find("td."+A.dataCellClass).width());var C=D.find("td."+A.dataCellClass).offset();var E=("insertBefore"==F)?parseInt(C.top):parseInt(C.top+D.find("td."+A.dataCellClass).height());var B=parseInt(C.left+H);var G=parseInt(D.width()-H);f("body").append('<div class="drop-indicator-bar" style="height: 1px; width: '+G+"px; position: absolute; top: "+E+"px; left: "+B+'px;"></div>')}function m(y){f(y).find("tr").removeClass("bg-nested-table-droppable-append-hover");f(".drop-indicator-bar").remove()}function c(B,A,D){var y=w(D);var z={x:Math.abs(B-y.x),y:Math.abs(A-y.y)};var C={x:z.x-(D.width()/2),y:z.y-(D.height()/2)};return Math.max(C.x,C.y)}function w(y){var z=f(y).offset();return{x:z.left+(f(y).width()/2),y:z.top+(f(y).height()/2)}}})(jQuery);