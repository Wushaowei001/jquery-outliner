(function(g){var f="bgOutliner";var e={addAsChild:false,addClass:"add-node",childHtml:'<td class="%dataCellClass%"><span class="add-edit-icons"><a href="#" title="Add node" class="%addClass%"><img src="../images/add.gif" alt="Add node" width="12" height="12" /></a><a href="#" title="Remove node" class="%removeClass%"><img src="../images/trash.gif" alt="Remove node" width="16" height="16" /></a></span><span class="%expColIconClass%"></span><span class="%dataClass%">Ny artikel</span></td><td></td><td></td>',childOfClassPrefix:"child-of-",collapsedClass:"collapsed",dataName:"data",dataClass:"nested-data",dataCellClass:"nested-data-cell",dragAndDrop:true,dragHandle:false,edit:true,expandCollapse:true,expandedClass:"expanded",expColIconClass:"expand-collapse-icon",hasChildrenClass:"has-children",hoverClass:"hover",idPrefix:"row",indent:20,initHidden:true,interval:30,levelClassPrefix:"level",onAddNode:false,onAppend:false,onBlur:false,onDelete:false,onDestroy:false,onDrop:false,onInit:false,onInsertBefore:false,onInsertAfter:false,prepend:false,removeClass:"remove-node",tolerance:1};var d={init:function(i){return this.each(function(){var l=g(this),k=l.data(f);if(k){throw new Error("jQuery."+f+" Init Error. Supplied element is already and instance of jQuery."+f)}if(l.children("tr").length<=0){throw new Error("jQuery."+f+" Init Error. Supplied element is not parent to any tr elements")}l.data(f,{settings:e});if(i){g.extend(l.data(f).settings,i)}i=l.data(f).settings;var j;if(i.initHidden){l.find("tr[class*='child-of-']").hide();j=i.collapsedClass}else{j=i.expandedClass}l.find("tr[class*='"+i.hasChildrenClass+"']").addClass(j);l.find("tr").each(function(){l.bgOutliner("setIndentation",g(this))});l.find("tr."+i.hasChildrenClass+" td."+i.dataCellClass+" ."+i.expColIconClass).live("click."+f,function(m){l.bgOutliner("toggleNode",g(this).closest("tr"));m.preventDefault()});l.find("tr").live("mouseover."+f,function(m){g(this).addClass(i.hoverClass)}).live("mouseout."+f,function(m){g(this).removeClass(i.hoverClass)});if(i.edit==true){l.bgOutliner("initEdit")}if(g.isFunction(i.onInit)){i.onInit.call(this)}})},initEdit:function(){var z=this;h(z);var t=z.data(f),r=t.settings;var p='<div class="drop-indicator-bar"><div class="col-indicator"><div class="thick-rule"></div></div><div class="row-indicator"><div class="thin-rule"></div></div></div>';t.dropIndicator=g(p);g("body").append(t.dropIndicator);t.dropIndicator.offset(z.offset());t.dropIndicator.width(z.outerWidth());var l,n,y,u={x:0,y:0},x,q=0,v,w,s={top:0,left:0},i,k,j=0;t.leftColumn=z.find("tr:first ."+r.expColIconClass).offset().left;t.topPosition=z.find("tr:first").offset().top;var m={appendTo:"body",revert:"invalid",revertDuration:0,drag:function(B,A){j=new Date().getTime();if(r.interval>j-q){return}q=j;k={x:B.pageX,y:B.pageY};if(u.x==k.x&&u.y==k.y){return}u=k;l=0,y=0,w=0,targetRowLevel=0,n=null,i=null;z.find("tr").each(function(){this.proportions={width:this.offsetWidth,height:this.offsetHeight};this.offset=g(this).offset();var C=g.ui.intersect(g.ui.ddmanager.current,this,"pointer");if(C){g(this).addClass(r.hoverClass)}else{g(this).removeClass(r.hoverClass)}});n=z.find("."+r.hoverClass+":first");v=k.x-t.leftColumn;if(v<=0){l=0}else{l=v/r.indent}l=parseInt(l);if(n.length>0){y=z.bgOutliner("getLevel",n);if(l>y+1){l=y+1}}else{l=0}t.invalidDropPositions=z.bgOutliner("getInvalidDropPositions",g(B.target).closest("tr"),l);if((n.index()+1) in b(t.invalidDropPositions)){l=z.bgOutliner("getLevel",z.find("tr:eq("+(t.invalidDropPositions[0]-1)+")"))}t.dropPositionsForLevel=z.bgOutliner("getDropPositionsForLevel",l);t.dropPositions=t.dropPositionsForLevel.filter(function(D,C){return t.invalidDropPositions.indexOf(D)==-1});g.each(t.dropPositions,function(C,D){if(n.index()==(D-1)){i=z.find("tr:eq("+(D-1)+")");return false}});w=l;if(i!=null&&i.length>0){s.top=parseInt(i.offset().top+i.height()-(t.dropIndicator.height()/2));s.left=z.offset().left;z.bgOutliner("showDropIndicator",s,w);t.target="after";t.targetRow=i;t.targetLevel=w;t.droppedNode=g(B.target)}else{if(k.y<t.topPosition){s.top=parseInt(t.topPosition-(t.dropIndicator.height()/2));s.left=z.offset().left;z.bgOutliner("showDropIndicator",s,w);t.target="before";t.targetRow=z.find("tr:first");t.targetLevel=w;t.droppedNode=g(B.target)}else{if(k.y>t.topPosition){w=0;i=z.find("tr:last");s.top=parseInt(z.find("tr:visible:last").offset().top+z.find("tr:visible:last").height()-(t.dropIndicator.height()/2));s.left=z.offset().left;z.bgOutliner("showDropIndicator",s,w);t.target="after";t.targetRow=i;t.targetLevel=0;t.droppedNode=g(B.target)}}}},stop:function(B,A){z.bgOutliner("hideDropIndicator");z.bgOutliner("insertAt",t.targetRow,t.targetLevel,t.droppedNode,t.target)},helper:function(B,A){var C=g('<div class="nested-table-item-dragging"><table class="'+f+'-dragging"></table></div>').find("table").append(g(B.target).closest("tr").clone().removeClass(z.data(f).settings.hoverClass));return C}};if(r.dragHandle!=false){m.handle=r.dragHandle}z.find("tr").draggable(m).data(f,true);z.find("tr").live("hover."+f,function(){if(g(this).data(f)!=true){g(this).data(f,true);g(this).draggable(m)}});z.find("td."+e.dataCellClass+" ."+e.addClass).live("click."+f,function(B){var A=z.bgOutliner("addNode",g(this).closest("tr"));B.preventDefault()});z.find("td."+e.dataCellClass+" ."+e.removeClass).live("click."+f,function(B){var A=z.bgOutliner("removeNode",g(this).closest("tr"));B.preventDefault()});return z},destroy:function(){return this.each(function(){var k=g(this),j=k.data(f);h(k);var i=k.data(f).settings;k.find("tr."+i.hasChildrenClass+" td."+i.dataCellClass+" ."+i.expColIconClass).die("click."+f);k.find("tr").die("hover."+f);if(i.edit=true){if(j.dropIndicator){j.dropIndicator.remove()}k.find("tr").draggable("destroy").removeData(f);k.find("td."+e.dataCellClass+" ."+e.removeClass).die("click."+f);k.find("td."+e.dataCellClass+" ."+e.addClass).die("click."+f)}if(g.isFunction(i.onDestroy)){i.onDestroy.call(this)}k.removeData(f)})},updateSettings:function(i){return this.each(function(){var j=g(this);h(j);if(i){g.extend(j.data(f).settings,i)}})},toggleNode:function(i){var j=this;h(j);a(j,i);i.toggleClass(j.data(f).settings.expandedClass);i.toggleClass(j.data(f).settings.collapsedClass);j.bgOutliner("toggleDescendants",i);return j},toggleDescendants:function(i){var l=this;h(l);a(l,i);var k=i.attr("id"),j=l.find(".child-of-"+k+"."+l.data(f).settings.expandedClass);if(j.length>0){j.each(function(){l.bgOutliner("toggleDescendants",g(this))})}this.find(".child-of-"+k).each(function(){g(this).toggle()});return l},expandNode:function(i){var k=this;h(k);a(k,i);var j=k.data(f).settings;if(i.hasClass(j.collapsedClass)){k.bgOutliner("toggleNode",i)}i.removeClass(j.collapsedClass).addClass(j.expandedClass);return k},collapseNode:function(i){var k=this;h(k);a(k,i);var j=k.data(f).settings;if(i.hasClass(j.expandedClass)){k.bgOutliner("toggleNode",i)}i.removeClass(j.expandedClass).addClass(j.collapsedClass);return k},expandAll:function(){var j=this;h(j);var i=j.data(f).settings;j.find("tr."+i.hasChildrenClass).each(function(){j.bgOutliner("expandNode",g(this))});return j},collapseAll:function(){var j=this;h(j);var i=j.data(f).settings;var k=j.find("tr."+i.hasChildrenClass+":visible").get().reverse();g.each(k,function(){j.bgOutliner("collapseNode",g(this))});return j},addNode:function(n){var s=this;h(s);if(n){a(s,n)}var k,j,p,q,t,m,i,u;var l=s.data(f).settings;if(l.addAsChild==false){var r=s.bgOutliner("getParent",n);n=(r!=null)?s.find("#"+l.idPrefix+r):null}if(n){s.bgOutliner("expandNode",n);j=s.bgOutliner("getLevel",n)+1;u=n.attr("id")}else{j=0;u=null}p=0;s.find("tr").each(function(){q=parseInt(g(this).attr("id").substring(l.idPrefix.length));p=(p<q)?q:p});p++;m=l.idPrefix+p.toString();t=l.childHtml.replace(/%dataCellClass%/ig,l.dataCellClass).replace(/%addClass%/ig,l.addClass).replace(/%removeClass%/ig,l.removeClass).replace(/%expColIconClass%/ig,l.expColIconClass).replace(/%dataClass%/ig,l.dataClass);i='<tr id="'+m+'" class="';if(u!=null){i=i+l.childOfClassPrefix+u+" "}i=i+l.levelClassPrefix+j+'">'+t+"</tr>";k=g(i);if(n){s.bgOutliner("appendNode",n,k)}else{if(l.prepend){s.prepend(k)}else{s.append(k)}}if(g.isFunction(l.onAddNode)){l.onAddNode.call(this,k)}return s},removeNode:function(i){var m=this;h(m);a(m,i);var l=m.data(f).settings;var j=m.bgOutliner("getParent",i);var k=m.find("."+l.childOfClassPrefix+l.idPrefix+j);if(k.length<=1){m.find("#"+l.idPrefix+j).removeClass(l.hasChildrenClass)}if(i.hasClass(l.hasChildrenClass)){m.find("."+l.childOfClassPrefix+i.attr("id")).each(function(){m.bgOutliner("removeNode",g(this))})}if(g.isFunction(l.onRemoveNode)){l.onRemoveNode.call(this,i)}i.remove();return m},appendNode:function(i,l){var q=this;h(q);a(q,i);var p=[l],n,j,k=i.index();var m=q.data(f).settings;if(l.parent().is("#"+q.attr("id"))){p=q.bgOutliner("getFamily",l);q.bgOutliner("setParent",i,l)}if(i.hasClass(m.hasChildrenClass)){if(!m.prepend){n=q.bgOutliner("getFamily",i);j=n[n.length-1];k=j.index()}}else{i.addClass(m.hasChildrenClass);q.bgOutliner("expandNode",i)}g.each(p,function(){g(this).insertAfter(q.find("tr:eq("+k+")"));q.bgOutliner("setIndentation",g(this));k++});if(g.isFunction(m.onAppend)){m.onAppend.call(this)}},insertAt:function(m,k,l,j){var r=this;h(r);a(r,m);a(r,l);var n=r.data(f).settings;var s=r.bgOutliner("getFamily",l),t=r.bgOutliner("getLevel",m),i=r.bgOutliner("getLevel",l),q,p;iSrcParent=r.bgOutliner("getParent",l);$srcSiblings=r.find("."+n.childOfClassPrefix+n.idPrefix+iSrcParent);if($srcSiblings.length<=1){r.find("#"+n.idPrefix+iSrcParent).removeClass(n.hasChildrenClass)}p=(k==0)?null:m.add(m.prevAll()).filter("."+n.levelClassPrefix+(k-1)).last();if(p!=null){if(!p.hasClass(n.hasChildrenClass)){p.addClass(n.hasChildrenClass)}r.bgOutliner("expandNode",p)}l.removeClass(n.levelClassPrefix+i).addClass(n.levelClassPrefix+k);r.bgOutliner("setIndentation",l);r.bgOutliner("setParent",p,l);if(m.is("#"+l.attr("id"))){m=m.prevAll().first()}if(j=="before"){r.prepend(l);iInsertPosition=0}else{l.insertAfter(m);iInsertPosition=m.index()+1}s.shift();g.each(s,function(){g(this).insertAfter(r.find("tr:eq("+iInsertPosition+")"));r.bgOutliner("setLevel",g(this)).bgOutliner("setIndentation",g(this));iInsertPosition=g(this).index()});return r},getFamily:function(i){var m=this;h(m);a(m,i);var j=m.data(f).settings;var l=[i],k=[];m.find("."+j.childOfClassPrefix+i.attr("id")).each(function(){if(g(this).hasClass(j.hasChildrenClass)){k=m.bgOutliner("getFamily",g(this));g.each(k,function(){l.push(g(this))})}else{l.push(g(this))}});return l},getParent:function(j){var m=this;h(m);a(m,j);var k,i,p,n;var l=m.data(f).settings;n=j.attr("class");if(n.indexOf(l.childOfClassPrefix)!=-1){p=n.indexOf(l.childOfClassPrefix)+l.childOfClassPrefix.length+l.idPrefix.length;i=n.indexOf(" ",p);k=(i!=-1)?parseInt(n.substring(p,i)):parseInt(n.substring(p))}else{k=null}return k},getLevel:function(k){var n=this;h(n);a(n,k);var j,i,p,m,l;var l=n.data(f).settings;m=k.attr("class");p=m.indexOf(l.levelClassPrefix)+l.levelClassPrefix.length;i=m.indexOf(" ",p);j=(-1!=i)?parseInt(m.substring(p,i)):parseInt(m.substring(p));return j},setParent:function(m,j){var n=this;h(n);a(n,j);var k=n.data(f).settings;var l=j.attr("class");var p=l.indexOf(k.childOfClassPrefix);var i=l.indexOf(" ",p);if(-1==p){l=false}else{l=(-1!=i)?l.substring(p,i):l.substring(p)}j.removeClass(l);if(m!=null){j.addClass(k.childOfClassPrefix+m.attr("id"))}return n},setLevel:function(k){var n=this;h(n);a(n,k);var l=n.data(f).settings;var i=n.bgOutliner("getLevel",k),j=n.bgOutliner("getParent",k),m=n.bgOutliner("getLevel",g("#"+l.idPrefix+j))+1;k.removeClass(l.levelClassPrefix+i).addClass(l.levelClassPrefix+m);return n},setIndentation:function(i){var l=this;h(l);a(l,i);var j=l.data(f).settings;var k=j.indent*l.bgOutliner("getLevel",i);i.find("."+j.dataCellClass+" ."+j.expColIconClass).css("margin-left",k+"px");return l},hasChildren:function(i){var k=this;h(k);a(k,i);var j=k.data(f).settings;return i.hasClass(j.hasChildrenClass)},showDropIndicator:function(n,j){var m=this;h(m);var l=m.data(f).settings;var i=m.data(f).leftColumn,k=i+(l.indent*(j));m.data(f).dropIndicator.show();m.data(f).dropIndicator.css({position:"absolute",top:n.top,left:n.left});m.data(f).dropIndicator.find(".col-indicator").width(k);m.data(f).dropIndicator.find(".row-indicator").width(m.data(f).dropIndicator.width()-k);return m},hideDropIndicator:function(){var i=this;h(i);i.data(f).dropIndicator.hide();return i},getDropPositionsForLevel:function(k){var n=this;h(n);var m=n.data(f).settings;var j=[],p,l,i;p=n.find("."+m.levelClassPrefix+k);if(k>0){l=n.find("."+m.levelClassPrefix+(k-1));l.each(function(){j.push(g(this).index()+1)})}else{j.push(0)}p.each(function(){if(n.bgOutliner("hasChildren",g(this))){i=n.bgOutliner("getFamily",g(this));j.push(i[i.length-1].index()+1)}else{j.push(g(this).index()+1)}});return c(j).sort(function(r,q){return(r-q)})},getInvalidDropPositions:function(k,j){var p=this;h(p);a(p,k);var l=p.data(f).settings;var n,m,i=[];n=p.bgOutliner("getFamily",k);g.each(n,function(){i.push(g(this).index()+1)});m=p.bgOutliner("getLevel",k);while(j<m){i.pop();j++}return i},};g.fn.bgOutliner=function(i){if(d[i]){return d[i].apply(this,Array.prototype.slice.call(arguments,1))}else{if(typeof i==="object"||!i){return d.init.apply(this,arguments)}else{throw new Error("Method "+i+" does not exist on jQuery."+f)}}};var h=function(i){if(!i.data(f)){throw new Error("jQuery."+f+" Instance Error. Element is not an instance of jQuery."+f)}return true};var a=function(j,i){if(!i.parent().is("#"+j.attr("id"))){throw new Error("jQuery."+f+" Error. Element is not child of instanced element")}return true};var c=function(k){var m=new Array();o:for(var l=0,q=k.length;l<q;l++){for(var j=0,p=m.length;j<p;j++){if(m[j]==k[l]){continue o}}m[m.length]=k[l]}return m};var b=function(j){var l={};for(var k=0;k<j.length;k++){l[j[k]]=""}return l}})(jQuery);